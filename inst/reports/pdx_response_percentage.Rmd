---
title: "GLMM"
output: html_document
params:
  data_frame: NA
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r data}
# df structure:
  # 1: Subject id
  # 2: Sensitivity factor (2 levels)
  # 3: Treatment factor (2 levels)
  # 4: Response percentage

df <- params$data_frame
# df <- openxlsx::read.xlsx("C:/Users/eduardogarcia/Documents/garcia_galea/t_monserrat/data/230322 table example for r script.xlsx") |>
#   janitor::clean_names() |>
#   dplyr::select(pdx_id, sensitivity, group, percent_ki67)

df_names <- names(df)
df <- df |>
  dplyr::mutate(
    response = .data[[df_names[4]]] / 100,
    dplyr::across(2:3, factor)
  )
```


```{r model}

# Model with random intercepts only
form1 <- call(
  "formula",
  stringr::str_c(
    "response ~ ", df_names[2], " * ", df_names[3],
    " + (1 | ", df_names[1], ")"
  )
)
model1 <- lme4::glmer(
  eval(form1), data = df, family = "binomial", weights = rep(100, nrow(df))
)

# Model with random intercepts and slopes
form2 <- call(
  "formula",
  stringr::str_c(
    "response ~ ", df_names[2], " * ", df_names[3],
    " + (1 + ", df_names[3], " | ", df_names[1], ")"
  )
)
model2 <- lme4::glmer(
  eval(form2), data = df, family = "binomial", weights = rep(100, nrow(df))
)

comp_models <- anova(model1, model2)

# If both models are different, we choose the best. If not, we choose the less
# complex (random intercepts only)
if (comp_models$`Pr(>Chisq)`[2] <= 0.05) {
  # The best model is allways on the second row.
  model <- get(rownames(comp_models)[2])
} else {
  model <- model1
}


```

```{r coefficients}
model_summary <- summary(model)
model_anova <- car::Anova(model, type = "III")

# Coefficients Confidence Intervals 
intervals <- confint(model)
coef_int <- list(
  # Lower coefficient values
  intervals[4:7, 1],
  # Coefficients values
  model_summary$coefficients[, 1],
  # Upper coefficients values
  intervals[4:7, 2]
)

```

```{r estimates}

sensitivity_levels <- levels(df[[2]])
treatment_levels <- levels(df[[3]])

parameters <- tibble::tibble(
  "{stringr::str_c(treatment_levels[1], '___', sensitivity_levels[1])}" := c(1, 0, 0, 0),
  "{stringr::str_c(treatment_levels[1], '___', sensitivity_levels[2])}" := c(1, 1, 0, 0),
  "{stringr::str_c(treatment_levels[2], '___', sensitivity_levels[1])}" := c(1, 0, 1, 0),
  "{stringr::str_c(treatment_levels[2], '___', sensitivity_levels[2])}" := c(1, 1, 1, 1),
)

estimates <- purrr::map_df(
  parameters,
  function(x) {
    purrr::map_dbl(coef_int, ~ sum(. * x) |> boot::inv.logit()) * 100
  }
) |>
  dplyr::mutate(
    interval = c("lower", "value", "upper")
  ) |>
  tidyr::pivot_longer(cols = 1:4) |>
  dplyr::mutate(
    "{df_names[3]}" := stringr::str_remove(name, "___.+$"),
    "{df_names[2]}" := stringr::str_remove(name, "^.+___")
  ) |>
  dplyr::select(
    tidyselect::all_of(c(df_names[2], df_names[3])), interval, value
  ) |>
  tidyr::pivot_wider(names_from = interval, values_from = value)
```

```{r estimates-plot}
ggplot2::ggplot(
    estimates, ggplot2::aes(
      .data[[df_names[3]]], value,
      group = .data[[df_names[2]]], color = .data[[df_names[2]]]
    )
  ) +
    ggplot2::geom_line(position = ggplot2::position_dodge(width = 0.1)) +
    ggplot2::geom_point(position = ggplot2::position_dodge(width = 0.1)) +
    ggplot2::geom_pointrange(
      ggplot2::aes(ymin = lower, ymax = upper),
      position = ggplot2::position_dodge(width = 0.1)
    ) +
    ggplot2::ylab(df_names[4]) +
    ggplot2::ylim(0, 100)
```

